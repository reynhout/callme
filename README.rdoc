= callme

A simple Ruby 1.9 demo C extension with a callback.

Extracted from ongoing efforts to write a Ruby interface to Apache ZooKeeper (github link soon).

There are three demos here, two using straight C extensions, and one using ruby-ffi.

== Status

The C_ext versions are now working, but the ruby-ffi version isn't yet (under MRI -- JRuby works great, thanks to Wayne Meissner).

Ultimately, MRI + ruby-ffi is my preferred environment, and now that the C_ext code is working, the FFI_lib version should come soon.

The C_ext versions might be useful as sample code, as this area seems somewhat thinly documented.  (Bug/bad style reports welcome!)


== C_ext versions

=== Usage

Create a localized Makefile, build the C lib, then run the Ruby code

  ruby1.9 extconf.rb
  make
  ruby1.9 runcallme.rb


== FFI_lib

=== Usage

Install ruby-ffi from Mercurial repo (0.4.0, presently not released/rubygem'ed)

  hg clone https://kenai.com/hg/ruby-ffi~mercurial
  cd ruby-ffi~mercurial
  rake1.9 gem
  gem1.9 install ffi-0.4.0.gem

Build and run as above.

You might need to make with MODEL=64 to build 64bit libs for JRuby.


=== Current behaviour (MRI, broken)
==== ruby 1.9.1p129 (2009-05-12 revision 23412) [i386-darwin9]

  USE_C_THR=true USE_RUBY_THR=false USE_C_CB=false ruby1.9 runcallme.rb

Starts up properly, but triggering the callback sometimes works and sometimes crashes MRI ("cfp consistency error - send").  When the callback does execute successfully, the Ruby threads apparently suspend.

...Sometimes this seems to consistently crash the second time the callback is triggered, othertimes not so consistently.

=== Current behaviour (JRuby, working!)
==== jruby 1.3.1 (ruby 1.8.6p287) (2009-06-15 2fd6c3d) (Java HotSpot(TM) 64-Bit Server VM 1.6.0_13) [x86_64-java]

  USE_C_THR=true USE_RUBY_THR=false USE_C_CB=false jruby runcallme.rb

Working..!  JRuby uses JVM threads, obviously...

You might need to make with MODEL=64 to build 64bit libs for JRuby.


== History

This started out as an attempt to make Apache ZooKeeper play with Ruby, via FFI.  Everything was going well until I tried the asynchronous functions with callbacks.  Sometimes the ruby code would appear to hang, sometimes the interpreter would crash.

I backed up a bit and wrote some sample code, still using FFI but not trying to talk to ZooKeeper.  Same problems.  This code is the FFI_lib version in this repo.

Then I decided to go straight to a C ext to see if I was using FFI incorrectly.  This code is the C_ext version in this repo.  Now that this is working, the FFI code should be resolved soon.


